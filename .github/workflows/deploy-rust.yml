name: Deploy Rust to VPS

on:
  workflow_dispatch: # Manual trigger
  push:
    branches:
      - main
    paths:
      - 'apps/rust/**'
      - '.github/workflows/deploy-rust.yml'

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0
  CARGO_NET_GIT_FETCH_WITH_CLI: true
  CARGO_REGISTRIES_CRATES_IO_PROTOCOL: sparse

jobs:
  build-and-deploy-rust:
    name: Build and Deploy Rust
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: apps/rust -> target

      - name: Install Dependencies
        run: |
          sudo apt-get update -qq && sudo apt-get install -y --no-install-recommends \
            build-essential pkg-config libssl-dev libmysqlclient-dev

      - name: Build Rust Release
        run: |
          export CARGO_TARGET_DIR=apps/rust/target
          cargo build --release --manifest-path apps/rust/Cargo.toml
          ls -lh apps/rust/target/release/rustexpress

      - name: Deploy to VPS
        env:
          SSH_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        run: |
          echo "$SSH_KEY" > /tmp/key && chmod 600 /tmp/key
          
          scp -o StrictHostKeyChecking=no -i /tmp/key \
            apps/rust/target/release/rustexpress \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:~/ultimate-asepharyana.cloud/apps/rust/target/release/
          
          ssh -o StrictHostKeyChecking=no -i /tmp/key ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} \
            'export PATH=$PATH:/home/asephs/.bun/bin && cd ~/ultimate-asepharyana.cloud && chmod +x apps/rust/target/release/rustexpress && pm2 restart ultimate-rust && pm2 save'
          
          rm -f /tmp/key
          echo "âœ… Deployed to https://ws.asepharyana.tech/"
