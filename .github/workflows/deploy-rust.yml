name: Deploy Rust to VPS

on:
  workflow_dispatch: # Manual trigger
  push:
    branches:
      - main
    paths:
      - 'apps/rust/**'
      - '.github/workflows/deploy-rust.yml'

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0
  CARGO_NET_GIT_FETCH_WITH_CLI: true
  CARGO_REGISTRIES_CRATES_IO_PROTOCOL: sparse

jobs:
  deploy-rust:
    name: Deploy Rust to VPS
    runs-on: ubuntu-latest
    steps:
      - name: Deploy and Build on VPS
        env:
          SSH_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        run: |
          echo "$SSH_KEY" > /tmp/deploy_key && chmod 600 /tmp/deploy_key
          
          ssh -o StrictHostKeyChecking=no -i /tmp/deploy_key ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} '
            export PATH=$PATH:/home/asephs/.bun/bin:/home/asephs/.cargo/bin:/usr/bin
            cd ${{ secrets.VPS_TARGET_DIR }}
            
            echo "ğŸ“¥ Pulling latest code from main..."
            git fetch origin
            git reset --hard origin/main
            
            echo "ğŸ”¨ Building Rust in release mode..."
            cd apps/rust
            cargo build --release
            
            echo "ğŸ”„ Restarting application with PM2..."
            cd ../..
            pm2 restart ultimate-rust
            pm2 save
            
            echo "âœ… Deployment successful!"
            echo "ğŸŒ Access at: https://ws.asepharyana.tech/"
          '
          
          rm -f /tmp/deploy_key
